# 进程

程序:只占用磁盘空间      --剧本
进程:运行起立的程序,占用内存,cpu等资源  -- 戏

时间中断:
cpu讲时间分片,当前时间分片用完后悔强行让进程让出cpu资源,给下一个进程
```ditaa
   ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
   │time1│time2│time3│time4│time5│time6│time7│ ... │  cpu时间切片
   └──▲──┴──▲──┴──▲──┴─────┴─────┴─────┴─────┴─────┘
      │     │     │                                 
      │     │     │                                 
      │     │     │                                 
     ┌┘     └─┐   └────┐                            
     │        │        │                            
     │        │        │                            
     │        │        │                            
┌────┴───┬────┴───┬────┴───┐                        
│process1│process2│  ...   │      进程                    
└────────┴────────┴────────┘       

```
进程仿佛同时处理多个进程,其实是分时的

#### 存储介质/运算过程
- 寄存器:32bit 4字节 64bit 8字节
- cache:从奔腾512k到现在i系列4M不等
- memory:需要看总线速率以及内存速度,从以前666M到现在1888M不等
- 磁盘:分物理磁盘/ssd,速度从1000/s到现在24M/s不等
- 
```ditaa
                                                               ┌──────────────────────────────────────────┐
                                                               │                   cpu                    │
                                                               │ ┌─────────────┐          ┌─────────────┐ │
                                                               │ │  registers  │          │     ALU     │ │
                                                               │ │    heap     │          │             │ │
                                ┌──────────────────────────────┼▶│             ◀──────────│  3.operate  │ │
                                │                              │ │4.save result│          │instructions │ │
                                │                              │ │             │          │             │ │
                                │                              │ └─────────────┘          └──────▲──────┘ │
                                │                              │                  ┌────┐         │        │
                                │                              │                  │MMU │         │        │
    │     ▲                ┌────────┐          ▲      ┃        │                  └────┘         │        │
    │     │                │register│          ┃      ┃        │                                 │        │
    │     │                └────────┘          ┃      ┃        │ ┌─────────────┐          ┌─────────────┐ │
    │     │                                    ┃      ┃        │ │  prefetch   │          │   decoder   │ │
    │     │              ┌────────────┐        ┃      ┃        │ │   buffers   │          │             │ │
    │     │              │   cache    │────────╋──────╋────────┼─▶             │─────────▶│             │ │
    │     │              └────────────┘      load     ┃        │ │ 1.prefetch  │          │  2.decode   │ │
   size   │                                    ┃      ┃        │ │instructions │          │             │ │
    │     │           ┌──────────────────┐     ┃   return      │ └─────────────┘          └─────────────┘ │
    │   access        │ memory(digital)  │     ┃      ┃        │                                          │
    │   speed         └──────────────────┘     ┃      ┃        └──────────────────────────────────────────┘
    │     │                                    ┃      ┃                                                    
    │     │       ┌──────────────────────────┐ ┃      ┃                                                    
    │     │       │   hard drive(physical)   │ ┃      ▼                                                    
    │     │       └──────────────────────────┘                                                             
    │     │                                                                                                
    │     │    ┌────────────────────────────────┐                                                          
    │     │    │            network             │                                                          
    ▼     │    └────────────────────────────────┘                                                          
```

注意:cpu计算的时候
- 1.预取器从cache拿到指令(例如add eax,ebx之类的汇编指令)
- 2.译码器译码
- 3.ALU操作
- 4.ALU操作结果放回寄存器堆
- 5.回到1
  
### 进程内存空间

#### 用户空间
每个进程拿到的都是虚拟内存.不管实际内存多大,虚拟内存总是给到很大的空间
ex:32bit拿到3G到0G的空间,4G到3G位置给内核.
例如下图的a.out b.out,执行的时候,每个进程都以为自己会拿到3G的内存空间.实际上内存的控制在MMU(cpu内),MMU拿到的时候进行实际内存(memory)的映射
注意:
- 内存分页是4k,是MMU决定的(也是这样设计的)
- 如果进程申请了很大的区间(ex int[1000000000]),对应memory是可能离散的,但是MMU进行管理,**逻辑上是连续的**
- 进程空间都不相关,例如a.out在8000位置需要写某个某个变量,b.out在8000写某个变量,**实际物理内存从MMU分配**,不会指向同一个地址
- 虚拟内存指的是一个进程**可以使用**的内存大小,但是一般一个进程很少用完这些**实际内存空间**

```ditaa
   a.out                                                                     b.out
┌─4G───────────────────────┐                           ┌────────┐     ┌─4G───────────────────────┐
│   ┌────┐                 │                           │ memory │     │   ┌────┐                 │
│   │pcb │                 │                           │ (512M) │     │   │pcb │                 │
│   │    │                 │                           │        │     │   │    │                 │
│   │    │                 │                           │        │     │   │    │                 │
│   │    │                 │                           │        │     │   │    │                 │
│   │    │                 │                           │        │     │   │    │                 │
│   │    │                 │                           ├────────┤     │   │    │                 │
│   └────┘                 │      ┌───────────────────▶│        │     │   └────┘                 │
│                          │      │                    ├────────┤     │                          │
├─3G───────────────────────┤      │                    │        │     ├───3G─────────────────────┤
│                          │      │                    ├────────┤     │                          │
│                          │      │                ┌──▶│        │     │                          │
│                          │      │                │   ├────────┤     │                          │
│                          │      │                │   └────────┘     │                          │
│                          │      │                │                  │                          │
│                          │      │                │                  │                          │
│                          │      │                │                  │                          │
│                          │      │                │                  │                          │
│                          │      │                │                  │                          │
│                          │      │                │                  │                          │
│                          │      │                │                  │                          │
│                          │      │                │                  │                          │
│                          │      │  ┌─────────┐   │                  │                          │
├──────────────────────────┤      │  │   MMU   │   │                  ├──────────────────────────┤
8000      int a=10         │──────┴──▶         ◀───┴──────────────────┤int a=10               8000
├──────────────────────────┤         └─────────┘                      ├──────────────────────────┤
│                          │                                          │                          │
├──────────────────────────┤                                          ├──────────────────────────┤
│                          │                                          │                          │
├──────────────────────────┤                                          ├──────────────────────────┤
│                          │                                          │                          │
└─0G───────────────────────┘                                          └──0G──────────────────────┘

```

#### 内核空间
内核空间是共享的.每个进程有自己的pcb,实际上是内核空间有各个进程的pcb.
因为内核空间的存在,进程之间有地方可以进行通信**IPC**
```ditaa
                                                       ┌────────┐                   
                                                       │ memory │                   
                                                       │ (512M) │                   
                                                       │        │                   
                                                       │        │                   
                                                       │        │                   
                                                       │        │                   
                                                       ├──┬┬──┬─┤                   
                                  ┌────────────────┬──▶│p1││p2│ │                   
                                  │                │   ├──┴┴──┴─┤                   
                                  │                │   │        │                   
                                  │                │   ├────────┤                   
                                  │                │   │        │                   
                                  │                │   ├────────┤                   
                                  │                │   └────────┘                   
                                  │                │                                
                                  │                │                                
                                  │                │                                
                                  │                │                                
                                  │                │                                
                                  │                │                                
┌──────────────────────────┐      │                │    ┌──────────────────────────┐
│   ┌────┐                 │      │                │    │   ┌────┐                 │
│   │pcb │                 │      │                │    │   │pcb │                 │
│   │    │                 │      │  ┌─────────┐   │    │   │    │                 │
│   │    │                 │      │  │   MMU   │   │    │   │    │                 │
│   │    │                 ├──────┴─▶│         │◀──┴────┤   │    │                 │
│   │    │                 │         └─────────┘        │   │    │                 │
│   │    │                 │                            │   │    │                 │
│   └────┘                 │                            │   └────┘                 │
│                          │                            │                          │
├──────────────────────────┤                            ├──────────────────────────┤
│                          │                            │                          │
│                          │                            │                          │
│                          │                            │                          │
│                          │                            │                          │
│                          │                            │                          │
│                          │                            │                          │
│                          │                            │                          │
│                          │                            │                          │
│                          │                            │                          │
│                          │                            │                          │
│                          │                            │                          │
│                          │                            │                          │
│                          │                            │                          │
├──────────────────────────┤                            ├──────────────────────────┤
│         int a=10         │                            │int a=10                  │
├──────────────────────────┤                            ├──────────────────────────┤
│                          │                            │                          │
├──────────────────────────┤                            ├──────────────────────────┤
│                          │                            │                          │
├──────────────────────────┤                            ├──────────────────────────┤
│                          │                            │                          │
└──────────────────────────┘                            └──────────────────────────┘
```


#### 用户区间/内核区间/切换
CPU会把内存分级,MMU在映射内存的时候进行了分级(windows有4级,linux2级:最核心的内核0级以及最外层的用户3级),**MMU通过分级**知道内存是属于内核空间还是用户空间.
切换内核态慢是因为需要MMU进行内存全局切换,0切换到3,3切换到0

## pcb
centos下在`/usr/src/kernels/3.10.0-957.5.1.el7.x86_64/include/linux/sched.h`
关心的是:
- **进程id**
- **进程状**态 就绪/初始化,运行,挂起,终止
- 进程恢复的时候需要的上次的cpu寄存器
- 虚拟地址空间的信息.MMU的映射存在这里
- 控制终端的信息(进程运行要不还要终端)
- **当前工作目录位**置
- **umask掩**码,是进程的概念.
- **fd**表
- **信号相关的信**息
- **用户id,组id**
- session 进程组
- 资源上限
  
进程状态转化
```ditaa
                       占用cpu时间(执行)
                        ┌─────────┐                         
     ┌─────────────────▶│ running │───────────────────┐     
     │                  └─────────┘                   │     
     │                       │                        │     
     │                       │                        │     
     │                       │                        │     
     ▼  等待cpu分配时间        │                        ▼     
┌─────────┐                  │                  ┌──────────┐
│  ready  │◀─────────────────┼──────────────────│suspending│ 暂停,等待除cpu意外的资源(sleep),主动放弃cpu.阻塞等会有
└─────────┘                  │                  └──────────┘
     │                       │                        │     
     │                       │                        │     
     │                       │                        │     
     │                       ▼                        │     
     │                  ┌─────────┐                   │     
     └─────────────────▶│  stop   │◀──────────────────┘     
                        └─────────┘                         
                        运行结束
```

#### 环境变量
主要的是,环境变量和main的参数放在第一个栈的底部(就是内存图中3G往下一点,还没有到栈的地方)




