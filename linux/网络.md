# 网络


### 协议
数据存储的规则,数据传输的规则

例如:传输文件的时候,开始先传文件名,然后传大小,然后传内容 -->ftp 的前身

分层模型结构
OSI 
七层模型,物数网传会表应
TCP/IP 
四层模型 网(链路层/网络接口层)网(网络层)传(传输层)应(应用层)
应用层: http ftp nfs ssh telnet
传输层: tcp udp
网络层: ip icmp igmp
链路层: 以太网帧协议,ARP协议

数据经过一层层的封装,最后在链路层进行传输.对端拿到包之后一层层解封,获取数据.
```ditaa
                                                                                                 
                     A                                                     B                     
                 ┌───────┐                                             ┌───────┐                 
                 │ data  │                                             │ data  │                 
                 └───────┘                                             └───────┘                 
                     │                                                     ▲                     
                     │                                                     │                     
                     │                                                     │                     
                     │                                                     │                     
                     ▼                                                     │                     
             ┌──────────────┐                                      ┌──────────────┐       ▲      
     │       │     data     │                                      │     data     │       │      
     │       ├──────────────┤                                      ├──────────────┤       │      
     │       │ application  │              user                    │ application  │    depackage 
     │    ───┼──────────────┼──────────────────────────────────────┼──────────────┼──▶    │      
 package     │transportation│            kernel                    │transportation│       │      
     │       ├──────────────┤     ─────────network─────────▶       ├──────────────┤       │      
     │       │   network    │                                      │   network    │       │      
     │       ├──────────────┤                                      ├──────────────┤       │      
     ▼       │     link     │                                      │     link     │       │      
             └──────────────┘                                      └──────────────┘              
```

应用层需要用户对数据进行封装.
传输层开始内核封装.
 
```ditaa
                                                      ┌────┐               
                                                      │data│               
                                                      └────┘               
                                                                           
                                                                           
                                                                           
                                     ┌────────────────┬────┐               
                                     │application head│data│               
                                     └────────────────┴────┘               
                                                                           
                                                                           
                                                                           
                          ┌──────────┬────────────────┬────┐               
                          │ TCP head │application head│data│               
                          └──────────┴────────────────┴────┘               
                                                                           
                                                                           
                                                                           
               ┌──────────┬──────────┬────────────────┬────┐               
               │ IP head  │ TCP head │application head│data│               
               └──────────┴──────────┴────────────────┴────┘               
                                                                           
                                                                           
┌──────────────┬──────────┬──────────┬────────────────┬────┬──────────────┐
│ethernet head │ IP head  │ TCP head │application head│data│ethernet tail │
└──────────────┴──────────┴──────────┴────────────────┴────┴──────────────┘
```

#### 以太网帧格式
```ditaa
┌────────────────┬─────────────┬─────────┬──────────────────────────────────────────────────┬────────┐
│MAC destination │ MAC source  │  type   │                       data                       │  CRC   │
└────────────────┴─────────────┴─────────┴──────────────────────────────────────────────────┴────────┘
                                                                                                      
 ─────────6──────▶──6──────────▶─2───────▶───────────────────46-1500────────────────────────▶──4─────▶
                                                                                                      

```
MAC地址:网卡硬件地址.厂商生产网卡的时候需要申请mac的空间.
目标MAC地址:在发送数据之前发送ARP请求获取MAC地址

#### ARP
ARP协议:根据IP地址获取mac地址 
ARP请求帧可以理解成以太网帧格式的一种特例

请求
```ditaa
┌─────────────────┬─────────────┬────┬─────┬──────────────┬──────────────┬────────────────┬──────────────┬────────┐
│ff:ff:ff:ff:ff:ff│ MAC source  │0806│8 bit│  MAC source  │  IP source   │ff:ff:ff:ff:ff:f│IP destination│  CRC   │
└─────────────────┴─────────────┴────┴─────┴──────────────┴──────────────┴────────────────┴──────────────┴────────┘
```
当前目标mac地址不知道,因此请求中都打上ff..ff
ARP请求发送后,在路由中转.路由表记录和路由器连接的其他路由器地址.路由对路由表的连接路由进行广播.如果是ARP的包头请求,收到的路由器会查看本机IP地址是否与请求包中目标IP地址一致,一致的话就回包,在回包中加上目标mac信息.不一致就丢弃.
回报的时候因为是发给source机器,因此发包的时候source的mac是自己的mac,但是目标mac就是请求中的source mac.包文中的信息也同样替换
根据格式填充的包文
```ditaa
┌─────────────┬────────────────┬────┬─────┬────────────────┬──────────────┬──────────────┬──────────────┬────────┐
│ MAC source  │MAC destination │0806│8 bit│MAC destination │IP destination│  MAC source  │  IP source   │  CRC   │
└─────────────┴────────────────┴────┴─────┴────────────────┴──────────────┴──────────────┴──────────────┴────────┘
```
RARP协议则是根据mac获取ip的请求 type是8035

#### 以太网帧格式
根据mac地址,完成数据报传输

#### IP协议

IP段格式
![](../imgs/network/ip_package_format.png)
**版本**:ipv4 ipv6 4位

**TTL**:time to live,这里time是次数.这里设置的是数据报在路由节点中的跳转上限.
有可能因为网络不通,到达不了的请求会在网路路由中不断找.
TTL是一个次数,每一跳(就是从一个路由器跳转到下一个路由器)都会-1.当TTL减少为0的时候,数据报被路由器丢弃,防止拥塞网络.

**32位源IP** 4字节    
**32位目标IP**  4字节

日常用的192.168.101.1 是转给人类看的,称为点分十进制IP地址.是字符串.   真正网络传输是二进制的IP地址.


IP地址:可以在网络环境中唯一表示一台主机.
port:可以在网络的一台主机上唯一表示进程
IP + port: 网络环境中标识唯一进程

一般是5000以下有指定,使用5000以上的端口号较好


#### UDP协议
![](../imgs/network/udp_package_format.png)
 


#### TCP协议
![](../imgs/network/TCP_package_format.png)
16位源端口号 2字节 2^16,65536 能描述最大的端口号
16位目的端口号 2字节 2^16 65536
32位序号
32位确认序号 相当于回执
6个标志位
16位窗口大小 65536


#### bs cs

||c s|b s|
|优点|缓存大量数据,协议选择灵活,速度快,|安全性好,跨平台,开发量小|
|缺点|安全性,不好跨平台,开发量大|不能缓存大量数据,严格遵守http|

#### 网络字节序
小端 intel提出.因为现在设备基本是intel芯片,所以很多机器是使用小端 little endian
高位存高地址,低位存低地址
ex:0x12345678
```ditaa
┌────┐ high
│ 12 │
├────┤
│ 34 │
├────┤
│ 56 │
├────┤
│ 78 │
└────┘ low
``` 

大端 IBM最初的协议.因为IBM最初做存储,因此网络使用大端 big endian
高位存低地址,低位存高地址
```ditaa
┌────┐  high
│ 78 │
├────┤
│ 56 │
├────┤
│ 34 │
├────┤
│ 12 │  low
└────┘
```

网络中使用大端解包.因此需要一次网络字节序和主机字节序的转换.

转换函数:
htonl //host to network long 本地转到网络(ip)
htons //host to network short 本地转网络(port)
ntohl //network to host long 网络转本地(ip)
ntohs //netowrk to host short 网络转本地(port)

