ipc,interprocess communication,进程间通信

# 版图
```ditaa
                                               ┌──────────────────────────┐                                                                                                                                                                                  
                                       ┌───────▶ pipe:simple but relative │                                                                                                                                                                                  
                                       │       └──────────────────────────┘                                                                                                                                                                                  
                                       │       ┌──────────────────────────┐                                                                                                                                                                                  
                                       ├───────▶    fifo:not relative     │                                                                                                                                                                                  
                                       │       └──────────────────────────┘                                                                                                                                                                                  
                                       │       ┌──────────────────────────┐                                                                                                                                                                                  
                ┌─────────────┐        ├───────▶signal:lowest resource use│                                                                                                                                                                                  
          ┌────▶│ IPC methods ├────────┤       └──────────────────────────┘                                                                                                                                                                                  
          │     └─────────────┘        │        ┌──────────────────────────┐                                                                                                                                                                                 
          │                            ├────────▶     shm:not relative     │                                                                                                                                                                                 
          │                            │        └──────────────────────────┘                                                                                                                                                                                 
          │                            │                                                                                                                                                                                                                     
          │                            │        ┌──────────────────────────┐                                                                                                                                                                                 
          │                            └────────▶           ...            │                                                                                                                                                                                 
          │                                     └──────────────────────────┘                                                                                                                                                                                 
          │                                                                                                                                                                                                                                                  
          │                                                     ┌──────────────┐                                                                                                                                                                             
          │                                                  ┌──▶  dummy file  │                                                                                                                                                                             
          │                                                  │  ├──────────────┤                                                                                                                                                                             
          │                                                  ├──▶ fd pair(r/w) │                                                                                                                                                                             
          │                                                  │  ├──────────────┴─────┐                                                                                                                                                                       
          │                                 ┌──────────────┐ ├──▶from w end to r end │                                                                                                                                                                       
          │                       ┌─────────▶   property   ├─┘  └────────────────────┘                                                                                                                                                                       
          │                       │         └──────────────┘                                                                                                                                                                                                 
          │                       │                             ┌──────────────┐                                                                                                                                                                             
          │                       │         ┌──────────────┐ ┌──▶kernel buffer │                                                                                                                                                                             
          │                       ├─────────▶  mechanism   ├─┤  ├──────────────┤                                                                                                                                                                             
          │                       │         └──────────────┘ └──▶  ring queue  │                                                                                                                                                                             
          │                       │                             └──────────────┘                                                                                                                                                                             
          │                       │                                                                                                                                                                                                                          
          │    ┌───────┐          │                                        ┌─────────────────────────────────┐                                                                                                                                               
          ├────▶ pipe  │──────────┐                                ┌───────▶  can not r and w in same proc   │                                                                                                                                               
          │    └───────┘          │                                │       ├─────────────────────────────────┤                                                                                                                                               
          │                       │                                ├───────▶   data cant be read repeatly    │                                                                                                                                               
          │                       │                                │       ├─────────────────────────────────┴──────────────┐                                                                                                                                
          │                       │         ┌──────────────┐       ├───────▶    semiduplex(data follows mono direction)     │                                                                                                                                
          │                       │─────────▶ limitations  ├───────┤       ├──────────────────────────────────────────┬─────┘                                                                                                                                
          │                       │         └──────────────┘       └───────▶   accessed by proc with same ancestor    │                                                                                                                                      
          │                       │                                        └──────────────────────────────────────────┘                                                                                                                                      
          │                       │         ┌──────────────┐               ┌──────────────┐            ┌──────────────┐                                                                                                                                      
          │                       ├─────────▶function pipe ├───────┬───────▶    param     ├────────────▶    fd[2]     │                                                                                                                                      
          │                       │         └──────────────┘       │       └──────────────┘            └──────────────┘                                                                                                                                      
          │                       │                                │                                                                                                                                                                                         
          │                       │                                │        ┌──────────────┐     ┌─────────┐                                                                                                                                                 
          │                       │                                └────────▶   returns    ├──┬──▶ succ:0  │                                                                                                                                                 
          │                       │                                         └──────────────┘  │  └─────────┘                                                                                                                                                 
          │                       │                                                           │  ┌─────────┐     ┌─────────┐                                                                                                                                 
          │                       │                                                           └──▶  fail   ├──┬──▶   -1    │                                                                                                                                 
          │                       │                                                              └─────────┘  │  └─────────┘                                                                                                                                 
          │                       │                                                                           │  ┌─────────┐                                                                                                                                 
          │                       │                                                                           └──▶  errno  │                                                                                                                                 
          │                       │                                                                              └─────────┘                                                                                                                                 
          │                       │                                               ┌───────────────┐   ┌─────────────────────────────────┐                                                                                                                    
          │                       │                               ┌─────────┐  ┌──▶ pipe has data ├───▶  read data, return bytes count  │                                                                                                                    
          │                       │                           ┌───▶  read   ├──┤  └───────────────┘   └─────────────────────────────────┘                                                                                                                    
          │                       │                           │   └─────────┘  │  ┌───────────────┐   ┌───────────────────────┐ ┌─────────────────────────────────┐                                                                                          
          │                       │                           │                └──▶no data in pipe├─┬─▶ not all w ends closed ├─▶    read end blocks for write    │                                                                                          
          │                       │         ┏━━━━━━━━━━━━━━┓  │                   └───────────────┘ │ └───────────────────────┘ └─────────────────────────────────┘                                                                                          
          │                       ├─────────▶    r & w     ───┐                                     │ ┌──────────────────────┐  ┌─────────────────────────────────┐                                                                                          
          │                       │         ┗━━━━━━━━━━━━━━┛  │                                     └─▶  all w ends closed   ├──▶            returns 0            │                                                                                          
          │                       │                           │                                       └──────────────────────┘  └─────────────────────────────────┘                                                                                          
          │                       │                           │                    ┌───────────────────────┐      ┌────────────────────────────────────────┐                                                                                                 
          │                       │                           │   ┌─────────┐  ┌───▶   all r ends closed   ├──────▶ get SIGPIPE signal for no r ends ready │                                                                                                 
          │                       │                           └───▶  write  ├──┤   └───────────────────────┘      └────────────────────────────────────────┘                                                                                                 
          │                       │                               └─────────┘  │                                  ┌───────────────┐   ┌───────────────┐                                                                                                      
          │                       │                                            │                              ┌───▶   pipe full   ├───▶block for write│                                                                                                      
          │                       │                                            │   ┌───────────────────────┐  │   └───────────────┘   └───────────────┘                                                                                                      
          │                       │                                            └───▶ not all r ends closed ├──┤   ┌───────────────┐   ┌───────────────┐                                                                                                      
          │                       │                                                └───────────────────────┘  └───▶ pipe not full ├───▶  write data   │                                                                                                      
          │                       │                                   ┌───────────────────┐                       └───────────────┘   └───────────────┘                                                                                                      
          │                       │         ┌───────────────────┐  ┌──▶  shell:ulimit -a  │                                                                                                                                                                  
          │                       ├─────────▶  get pipe buffer  ├──┤  ├───────────────────┤                                                                                                                                                                  
          │                       │         └───────────────────┘  └──▶function:fpathconf │                                                                                                                                                                  
          │                       │                                   └───────────────────┘                                                                                                                                                                  
          │                       │                                  ┌───────────┐    ┌───────────┐                                                                                                                                                          
          │                       │                               ┌──▶   goods   ├────▶  simple   │                                                                                                                                                          
          │                       │                               │  └───────────┘    └───────────┘                                                                                                                                                          
          │                       │         ┌───────────────────┐ │                                                                                                                                                                                          
          │                       └─────────▶  goods and bads   ├─┤                    ┌───────────┐                                                                                                                                                         
          │                                 └───────────────────┘ │                 ┌──▶semiduplex │                                                                                                                                                         
          │                                                       │  ┌───────────┐  │  └───────────┘                                                                                                                                                         
          │                                                       └──▶   bads    ├──┤  ┌─────────────────────┐                                                                                                                                               
          │                                                          └───────────┘  └──▶ accessed by related │                                                                                                                                               
          │                                                                            └─────────────────────┘                                                                                                                                               
          │                                                                                                                                                                                                                                                  
          │                             ┌─────────────────────────────────────┐                                                                                                                                                                              
          │                    ┌────────▶named pipe(basic file type in linux) │                                                                                                                                                                              
┌────┐    │                    │        └─────────────────────────────────────┘                                                                                                                                                                              
│IPC │────┤                    │                        ┌────────────────────┐                                                                                                                                                                               
└────┘    │                    │                      ┌─▶    shell:mkfifo    │                         ┌─────────────┐                                                                                                                                       
          │                    │        ┌───────────┐ │ └────────────────────┘     ┌─────────────┐  ┌──▶    name     │                                                                                                                                       
          │                    ├────────▶  create   ├─┤ ┌────────────────────┐  ┌──▶   params    ├──┤  ├─────────────┤                                                                                                                                       
          │                    │        └───────────┘ └─▶  function:mkfifo   ├──┤  └─────────────┘  └──▶    mode     │                                                                                                                                       
          │                    │                        └────────────────────┘  │                      └─────────────┘                                                                                                                                       
          │                    │                                                │                                                                                                                                                                            
          │                    │                                                │                      ┌─────────────┐                                                                                                                                       
          │    ┌───────┐       │                                                │  ┌─────────────┐  ┌──▶   succ:0    │                                                                                                                                       
          ├────▶ fifo  ├───────┤                                                └──▶   returns   ├──┤  ├─────────────┴────┐                                                                                                                                  
          │    └───────┘       │                                                   └─────────────┘  └──▶ fail:-1 & errno  │                                                                                                                                  
          │                    │                                                                       └──────────────────┘                                                                                                                                  
          │                    │                                                                                                                                                                                                                             
          │                    │                                             ┌─────────────┐                                                                                                                                                                 
          │                    │        ┌─────────────────────────────┐  ┌───▶use same fifo│                                                                                                                                                                 
          │                    └────────▶  IPC for no relative proc   ├──┤   ├─────────────┴─────┐                                                                                                                                                           
          │                             └─────────────────────────────┘  └───▶ multi r & w ends  │                                                                                                                                                           
          │                                                                  └───────────────────┘                                                                                                                                                           
          │                                                                                                                                                                                                                                                  
          │                                                           ┌────────────────────┐                                                                                                                                                                 
          │                                                        ┌──▶share fds after fork│                                                                                                                                                                 
          │                                 ┌────────────────────┐ │  └────────────────────┘                                                                                                                                                                 
          │                             ┌───▶   IPC with file   ─┼─┤  ┌───────────────────────────────────────────┐                                                                                                                                          
          │                             │   └────────────────────┘ └──▶    open same file in no relative procs    │                                                                                                                                          
          │                             │                             └───────────────────────────────────────────┘                                                                                                                                          
          │                             │                                                                                                                                                                                                                    
          │                             │                                                                                                                                                                                                                    
          │                             │                                                                                                                                                                                                                    
          │                             │                                                                               ┌────────────────────────────────────────────────────────┐                                                                           
          │                             │                                                                          ┌────▶ addr:address of mapped memory. NULL for adjusted by os │                                                                           
          │                             │                                                                          │    └────────────────────────────────────────────────────────┘                                                                           
          │                             │                                                                          │                                                                                                                                         
          │                             │                                                                          │    ┌─────────────────────────────────┐                                                                                                  
          │                             │                                                                          ├────▶  length:size of mapped memory   │                                                                                                  
          │                             │                                                                          │    └─────────────────────────────────┘                                                                                                  
          │                             │                                                                          │                                ┌─────────────┐                                                                                          
          │                             │                                                                          │                            ┌───▶ PROT_WRITE  │                                                                                          
          │                             │                                                                          │                            │   ├─────────────┤                                                                                          
          │                             │                                                                          │                            ├───▶  PROT_READ  │                                                                                          
          │                             │                                                                          │    ┌───────────────────┐   │   ├─────────────┴─────────┐                                                                                
          │                             │                                                                          ├────▶ prot(protection): ├───┼───▶ PROT_READ|PROT_WRITE  │                                                                                
          │                             │                                                                          │    └───────────────────┘   │   ├───────────────────────┴─────────┐                                                                      
          │                             │                                                                          │                            ├───▶ PROT_EXEC:pages may be executed │                                                                      
          │                             │                                                                          │                            │   ├─────────────────────────────────┴────┐                                                                 
          │                             │                                                                          │                            └───▶ PROT_NONE:pages may not be accessed  │                                                                 
          │                             │                              ┌───────────────────────────┐               │                                └──────────────────────────────────────┘                                                                 
          │                             │                         ┌────▶   map memory with file    │               │                             ┌─────────────────────────────────────────────────┐                                                         
          │                             │                         │    └───────────────────────────┘               │                        ┌────▶ MAP_SHARED:memory can be shared by relate procs │                                                         
          │                             │                         │                                                │                        │    └─────────────────────────────────────────────────┘                                                         
          │                             │                         │                                                │     ┌──────────────┐   │    ┌─────────────────────────────────────────────────────────┐                                                 
          │                             │    ┏━━━━━━━━━━━━━━┓     │                                                ├─────▶    flags     ├───┼────▶  MAP_PRIVATE:memory cant be shared,with COW mechanism   │                                                 
          │                             ├────▶memory mapping┃─────┤                                                │     └──────────────┘   │    └─────────────────────────────────────────────────────────┘                                                 
          │                             │    ┗━━━━━━━━━━━━━━┛     │                                                │                        │    ┌──────────────────────────────────────────────────────────────────────────────────────────────────────────┐
          │                             │                         │                               ┌──────────┐     │                        └────▶ MAP_ANONYMOUS/MAP_ANON:mapping is not backed by any file.fd and offset args are ignored.in kernel >= 2.4 │
          │                             │                         │                         ┌─────▶  params  │─────┤     ┌──────────────┐        └──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
          │                             │                         │                         │     └──────────┘     ├─────▶      fd      │                                                                                                                    
          │                             │                         │                         │                      │     └──────────────┘                                                                                                                    
          │                             │                         │                         │                      │     ┌───────────────────────────┐                                                                                                       
          │                             │                         │                         │                      └─────▶offset:size in times of 4K │                                                                                                       
          │                             │                         │    ┌──────────────┐     │                            └───────────────────────────┘                                                                                                       
          │                             │                         ├────▶mmap function ├─────┤                       ┌───────────────────────────────┐                                                                                                        
          │                             │                         │    └──────────────┘     │                    ┌──▶ succ:address of mapping aera  │                                                                                                        
          │                             │                         │                         │      ┌──────────┐  │  └───────────────────────────────┘                                                                                                        
          │                             │                         │                         └──────▶ returns  │──┤  ┌──────────┐     ┌──────────┐                                                                                                            
          │                             │                         │                                └──────────┘  └──▶  fail:   │──┬──▶MAP_FAILED│                                                                                                            
          │                             │                         │                                                 └──────────┘  │  └──────────┘                                                                                                            
          │                             │                         │                                                               │  ┌──────────┐                                                                                                            
          │                             │                         │                                                               └──▶  errno   │                                                                                                            
          │                             │                         │                                                                  └──────────┘                                                                                                            
          │                             │                         │                                                                                                                                                                                          
          │                             │                         │                                              ┌────────────────────────┐                                                                                                                  
          │                             │                         │                                           ┌──▶ returned value of mmap │                                                                                                                  
          │                             │                         │                            ┌──────────┐   │  └────────────────────────┘                                                                                                                  
          │                             │                         │                        ┌───▶  params  │───┤  ┌────────────────────────┐                                                                                                                  
          │                             │                         │                        │   └──────────┘   └──▶         length         │                                                                                                                  
          │                             │                         │    ┌────────────────┐  │                     └────────────────────────┘                                                                                                                  
          │                             │                         ├────▶munmap function ├──┤                    ┌───────────────────────────────┐                                                                                                            
          │                             │                         │    └────────────────┘  │                 ┌──▶            succ:0             │                                                                                                            
          │                             │                         │                        │  ┌──────────┐   │  └───────────────────────────────┘                                                                                                            
          │                             │                         │                        └──▶ returns  │───┤  ┌──────────┐     ┌──────────┐                                                                                                                
          │                             │                         │                           └──────────┘   └──▶  fail:   │──┬──▶    -1    │                                                                                                                
          │                             │                         │                                             └──────────┘  │  └──────────┘                                                                                                                
          │                             │                         │                                                           │  ┌──────────┐                                                                                                                
          │                             │                         │                                                           └──▶  errno   │                                                                                                                
          │                             │                         │                                                              └──────────┘                                                                                                                
          │   ┌────────────────────┐    │                         │                                                                                                                                                                                          
          └───▶  share memory map  │────┤                         │                                                                                                                                                                                          
              └────────────────────┘    │                         │                             ┌─────────────────────────────────────────────┐                                                                                                              
                                        │                         │                         ┌───▶  mapping with fd read. fd need to be read   │                                                                                                              
                                        │                         │                         │   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━━━━━━━━━━┓                                                                                                  
                                        │                         │                         ├───▶ mapping permission <= fd permission in MAP_SHARED mode  ┃                                                                                                  
                                        │                         │                         │   ┣─────────────────────────────────────────────┳━━━━━━━━━━━┛                                                                                                  
                                        │                         │    ┏━━━━━━━━━━━━━━━━┓   ├───▶   after mapping created, fd can be closed   │                                                                                                              
                                        │                         └────▶     notice     ┃───┤   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓                                    
                                        │                              ┗━━━━━━━━━━━━━━━━┛   ├───▶ mapping cant be created with fd in size 0. fd size need to be truncated. param length shall be smaller than file size ┃                                    
                                        │                                                   │   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛                                    
                                        │                                                   ├───▶  param of munmap must be the same as returns of mmap   │                                                                                                   
                                        │                                                   │   ├────────────────────────────────────────────────────────┴───────────┐                                                                                       
                                        │                                                   ├───▶  param diff in mmap must be times of 4k, or args invalid returns   │                                                                                       
                                        │                                                   │   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳───────────────────────────┘                                                                                       
                                        │                                                   ├───▶ it's a must to check returns of mmap!  ┃                                                                                                                   
                                        │                                                   │   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓                                                                        
                                        │                                                   └───▶ proc core if access address that larger than roundup of file end.proc get SIGSEV  ┃                                                                        
                                        │                                                       ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛                                                                        
                                        │                                                                                                                                                                                                                    
                                        │                                                       ┌─────────────────────────────────────────────┐                                                                                                              
                                        │                                       ┌──────────┐  ┌─▶     MAP_PRIVATE:mapping cant be shared      │                                                                                                              
                                        │                                   ┌───▶  flags   │──┤ ├─────────────────────────────────────────────┤                                                                                                              
                                        │                                   │   └──────────┘  └─▶ MAP_SHARED:mapping shared for communication │                                                                                                              
                                        │                                   │                   └─────────────────────────────────────────────┘                                                                                                              
                                        │    ┌─────────────────────────┐    │                                                                                                                                                                                
                                        ├────▶  mmap in relative proc  │────┤                                               ┌──────────────────────────┐                                                                                                     
                                        │    └─────────────────────────┘    │                                             ┌─▶ 1.open fd with r w flag  │                                                                                                     
                                        │                                   │    ┌─────────────────────────────────────┐  │ ├──────────────────────────┴──────────┐                                                                                          
                                        │                                   └────▶shared with father proc and son proc │──┼─▶ 2.create mapping in MAP_SHARED flag │                                                                                          
                                        │                                        └─────────────────────────────────────┘  │ ├──────────────────────────┬──────────┘                                                                                          
                                        │                                                                                 └─▶          3.fork          │                                                                                                     
                                        │                                                                                   └──────────────────────────┘                                                                                                     
                                        │                                                                                                                                                                                                                    
                                        │                                                                          ┌─────────────────┐                                                                                                                       
                                        │                                                                       ┌──▶ length:ignored  │                                                                                                                       
                                        │                                                                       │  └─────────────────┘     ┌─────────────────┐                                                                                               
                                        │                                                       ┌───────────┐   │  ┌─────────────────┐  ┌──▶  MAP_ANONYMOUS  │                                                                                               
                                        │                                                    ┌──▶   linux   │───┼──▶     flags:      │──┤  ├─────────────────┤                                                                                               
                                        │    ┌───────────────────────────────────────────┐   │  └───────────┘   │  └─────────────────┘  └──▶    MAP_ANON     │                                                                                               
                                        ├────▶unnamed mapping(effected in related procs) │───┤                  │  ┌─────────────────┐     └─────────────────┘                                                                                               
                                        │    └───────────────────────────────────────────┘   │                  └──▶      fd:-1      │                                                                                                                       
                                        │                                                    │                     └─────────────────┘                                                                                                                       
                                        │                                                    │                     ┌─────────────────┐                                                                                                                       
                                        │                                                    │  ┌───────────┐   ┌──▶ length:ignored  │                                                                                                                       
                                        │                                                    └──▶ UNIX like │───┤  └─────────────────┘                                                                                                                       
                                        │                                                       └───────────┘   │  ┌─────────────────┐                                                                                                                       
                                        │                                                                       └──▶fd:open("dev/zero│                                                                                                                       
                                        │                                                                          └─────────────────┘                                                                                                                       
                                        │                                                                                                                                                                                                                    
                                        │                                                                                                                                                                                                                    
                                        │                                        ┌────────────────────────────────────┐                                                                                                                                      
                                        │                                   ┌────▶  1.create mapping with same file   │                                                                                                                                      
                                        │                                   │    ├────────────────────────────────────┤                                                                                                                                      
                                        │    ┌─────────────────────────┐    ├────▶    2.mapping in MAP_SHARED flag    │                                                                                                                                      
                                        └────▶mmap in no relative procs│────┤    ├────────────────────────────────────┴───────────────┐                                                                                                                      
                                             └─────────────────────────┘    ├────▶  3.multi-read-ends and multi-write-ends supported  │                                                                                                                      
                                                                            │    ├──────────────────────────┬─────────────────────────┘                                                                                                                      
                                                                            ├────▶ 4.MAP_ANON cant be used  │                                                                                                                                                
                                                                            │    ├──────────────────────────┴─────┐                                                                                                                                          
                                                                            └────▶ 5./dev/zero file cant be used  │                                                                                                                                          
                                                                                 └────────────────────────────────┘                                                                                                                                          
```


## ipc机制
进程间通信本质是在内核中建立缓冲区(一般大小4096),让不同进程在内核空间进行写/读

```ditaa

+-----------------------------------------+
|                   kernel                |
|             +------------+              |
|      +----->|    缓冲区   |-------+      |
|      |      +------------+       |      |
|      |                           |      |
|      |                           |      |
+------+------+-------------+------+------+
|      |      |             |      |      |
|      |      |             |      |      |
|      |      |             |      |      |
|      |      |             |      |      |
|      |      |             |      |      |
|      |      |             |      v      |
|   +----+    |             |   +----+    |
|   |    |    |             |   |    |    |
|   +----+    |             |   +----+    |
| process 1   |             |   process 2 |
|             |             |             |
|             |             |             |
|             |             |             |
+-------------+             +-------------+

```

ipc很多
- 文件
- 管道
- 信号
- 共享内存
- 消息队列
- socket
- 命名管道 没有血缘关系的也能用
- ...

现在常用的
- fifo(命名管道)最简单 只能血缘关系的,父子,兄弟,子孙等 没血缘关系的不能
- 信号 开销小 携带数据量有限,内存/cpu占用小,但是快
- 共享内存 无血缘关系 
- 本地socket 最稳定 实现复杂度最高

## pipe
需要有血缘关系.调用pipe 或者 mkfifo 
- 本质是伪文件
- 由两个fd引用,一个表示读,一个表示写 
- 规定数据写端流入,读端流出

原理:内核使用环状队列机制,借助内核缓冲区(4k)实现 
局限:
- 不能进程自己写自己读
- 数据不可反复读取,读走数据就不存在 相当于队列的出队
- 半双工通信,只能单方向流动
- 只能在公共祖先的进程之间使用pipe



 通信类型
- 单双工 单向发送信号  固定接收方和发送方 ex:遥控器
- 双向半双工 两端指定了方向后只能一个方向流动 发送方和接收方可以指定 但是指定只有不能变 ex:对讲机 pipe
- 双向全双工 可以两端进出 ex:电话 socket

int pipe(int pipefd[2])
- 创建并打开管道  pipefd[0]读 pipefd[1]写
- 成功:0
- 失败:-1 errno

父子进程读写
```ditaa
                            ┌──────────────────────────┐      
         ┌─────────────────▶│   r      pipe       w    │◀─┐   
         │                  └──────────────────────────┘  │   
         │                                                │   
  ┌─────────────┐                                         │   
  │ proc father │─────────────────────────────────────────┘   
  └─────────────┘                                             
                                                              
                                │                             
                              fork                            
                         for shared fds                       
                                │                             
                                │                             
                                │                             
                                ▼                             
                                                              
 ┌─────────────┐                                              
 │  proc son   │────────────────────────────────────────┐     
 └─────────────┘                                        │     
        │                                               │     
        │                                               │     
        │                 ┌──────────────────────────┐  │     
       ┌┴────────────────▶│   r      pipe       w    │◀─┤     
       │                  └──────────────────────────┘  │     
       │                                                │     
┌─────────────┐                                         │     
│ proc father │─────────────────────────────────────────┘     
└─────────────┘                                               
                               │                              
                               │                              
                               │                              
                        father cut read                       
                         son cut write                        
                               │                              
                               │                              
                               │                              
                               │                              
                               ▼                              
      ┌─────────────┐                                         
      │  proc son   │                                         
      └─────────────┘                                         
             │                                                
             │                                                
             │                 ┌──────────────────────────┐   
             └────────────────▶│   r      pipe       w    │◀─┐
                               └──────────────────────────┘  │
                                                             │
     ┌─────────────┐                                         │
     │ proc father │─────────────────────────────────────────┘
     └─────────────┘                                          
```

实现
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main()
{
    int ret;
    int fd[2];
    ret = pipe(fd);
    if(ret == -1){
        sys_err("pipe err");
    }
    pid_t pid = fork();
    if(pid > 0){
        close(fd[0]);
        write(fd[1],"hello pipe",sizeof("hello pipe"));
        close(fd[1]);
    }else if(pid == 0){
        close(fd[1]);
        char buf[1024];
        int size = read(fd[0], buf,sizeof(buf));
        write(STDOUT_FILENO, buf, size);
        close(fd[0]);
    }
    else{
        sys_err("fork err");
    }
    return 0;
}

```

#### 管道读写行为
管道可能会不够用,内核会扩容
读管道
- 有数据,返回读到字节数
- 没数据:
> - 写端全部关闭,返回0 相当于读到文件尾部
> - 写端没全部关闭,阻塞等待,让出cpu(挂起)
 
|写端|管道有数据|管道没数据|
|---|---|---|
|全部关闭|读数据,返回字节数(不管,读了再说)|返回0(没数据也没人写,不管)|
|没有全部关闭|读数据,返回字节数(不管,读了再说)|阻塞(管道没数据,但是有进程可能写)|
总结:有得读就读,没得读就看下是不是关了写,写都关了就不读(都没人写,读毛),写还没关就阻塞(可能别人还写啊)

写管道
- 读端全部关闭,进程异常(收到SIGPIPE信号,进程不终止)
- 读端没有全部关闭
> - 管道满:阻塞(少见)
> - 管道未满:write写入,返回实际写入字节数

|读端|管道未写满|管道写满|
|---|---|---|
|未全部关闭|写(还能写就写)|阻塞(等读的消耗了才能写,环状队列就这么多)|
|全部关闭|进程异常(SIGPIPE,都没有进程读还写?)|进程异常(SIGPIPE,都没有进程读还写?)|
总结:有读接口没关就写,就看下怎么写.管道有空间就写,没空间就阻塞.读接口都关了,直接拿到SIGPIPE(都没人读你还写??)

如果写端不写,阻塞后关闭
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main()
{
    int ret;
    int fd[2];
    ret = pipe(fd);
    if(ret == -1){
        sys_err("pipe err");
    }
    pid_t pid = fork();
    if(pid > 0){
        close(fd[0]);
        sleep(2);
        /* write(fd[1],"hello pipe\n",sizeof("hello pipe\n")); */
        close(fd[1]);
    }else if(pid == 0){
        close(fd[1]);
        char buf[1024];
        int size = read(fd[0], buf,sizeof(buf));
        printf("child read pipe size=%d\n",size);
        write(STDOUT_FILENO, buf, size);
        close(fd[0]);
    }
    else{
        sys_err("fork err");
    }
    return 0;
}
```
可以看到结果
```
➜  linux ./pipe
child read pipe size=0
```
过了3s只有返回,说明子进程阻塞等待,发现fd已经关闭,返回0

使用pipe进行ls|wc -l
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main()
{
    int pipefd[2];
    int ret = pipe(pipefd);
    if(0 > ret){
        sys_err("pipe err");
    }
    pid_t pChild = fork();
    if(pChild < 0){
        sys_err("fork err");
    }
    else if(pChild == 0){//child
        close(pipefd[1]);
        ret = dup2(pipefd[0], STDIN_FILENO);
        if(ret < 0){
            sys_err("son fup2 err");
        }
        execlp("wc", "wc", "-l", NULL);

        sys_err("son wc err");
    }
    else{//father
        close(pipefd[0]);
        ret = dup2(pipefd[1], STDOUT_FILENO);
        if(ret < 0){
            sys_err("father fup2 err");
        }
        execlp("ls","ls", NULL);
        sys_err("father ps err");
    }
    return 0;
}

```
使用兄弟进程做ls wc
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/wait.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main()
{
    int pipefd[2];
    int ret = pipe(pipefd);
    if(0 > ret){
        sys_err("pipe err");
    }
    int i = 0;
    for(i  = 0; i < 2; i++)
    {
        pid_t pChild = fork();
        if(pChild < 0){
            sys_err("fork err");
        }
        if(pChild == 0){//child
            if(i == 1){
                printf("in little bro\n");

                close(pipefd[1]);
                ret = dup2(pipefd[0], STDIN_FILENO);
                if(ret < 0){
                    sys_err("son fup2 err");
                }
                execlp("wc", "wc", "-l", NULL);

                sys_err("son wc err");
            }
            else if(i == 0)
            {

                printf("in big bro\n");
                close(pipefd[0]);
                ret = dup2(pipefd[1], STDOUT_FILENO);
                if(ret < 0){
                    sys_err("father fup2 err");
                }
                execlp("ls","ls", NULL);
                sys_err("father ps err");

            }
        }
        else{
            continue;
        }

    }
    close(pipefd[0]);
    close(pipefd[1]);

    while((ret = wait(NULL)) < 0){}

    return 0;
}
```

允许pipe有多个写端,多个读端,但不能保证读和写的顺序.但是这个场景不能多用,可能乱序
(当然允许,fork的时候就有多个读端多个写端)

管道缓冲区大小
使用ulimit -a看当前系统管道文件以及内核缓冲区大小
stack只有8192k 所以很多时候只能malloc


## FIFO
因为pipe只能有血缘关系才能使用,fifo出现解决没有血缘能做pipe能力的事情
叫命名管道.pipe是非命名管道

虽然进程用户空间独立,但是内核区共享.共享区创建缓存,进程之间进行共享.参考[ipc机制](##ipc机制)
命令行  mkfifo 
函数 int mkfifo(const char* pathname, mode_t mode);

fifo和文件的用法类似,指定路径下读取/写入管道达到进程之间的通信目的
测试:
```cpp
//写
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    int fd, i;
    char buf[4096];
    if(argc < 2){
        printf("input filename\n");
        return -1;
    }
    fd = open(argv[1], O_WRONLY);
    if(fd < 0){
        perror("open");
    }
    i = 0;
    while(1){
        sprintf(buf, "hello i = %d\n",i++);
        write(fd, buf,strlen(buf));
        sleep(1);
    }
    close(fd);

    return 0;
}

//读
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    int fd, i ,len;
    char buf[4096];
    if(argc < 2){
        printf("input filename\n");
        return -1;
    }
    fd = open(argv[1], O_RDONLY);
    if(fd < 0){
        perror("open");
    }
    i = 0;
    while(1){
        len = read(fd,buf,sizeof(buf));
        write(STDOUT_FILENO, buf,len);
        sleep(3);
    }
    close(fd);

    return 0;
}
```
一读多写:写顺序不能保证 全部出队
多读一些:取出顺序不能保证,但是进程1读了的进程2读不到

## mmap
可以直接使用文件,没有血缘的进程进行通信
ex:a写入,b lseek到文件头然后读

内存映射直接把磁盘文件映射到内存中,修改内存直接修改磁盘文件.
```ditaa
┌───────────────────┐             ┌───────────────────┐
│      memory       │             │       disk        │
│                   │             │                   │
│                   │             │                   │
│                   │             │                   │
├───────────────────◀──map────────┼───────────────────┤
│███████████████████│             │███████████████████│
│███████████████████│             │███████████████████│
│███████████████████│             │███████████████████│
│███████████████████│             │███████████████████│
│███████████████████│             │███████████████████│
│███████████████████│             │███████████████████│
├──────────────────◀┼─────map─────┼───────────────────┤
│                   │             │                   │
│                   │             │                   │
│                   │             │                   │
│                   │             │                   │
│                   │             │                   │
│                   │             │                   │
└───────────────────┘             └───────────────────┘
```

创建共享内存映射
include: <sys/mman.h>
void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);

- addr 指定映射区首地址 通常传NULL,让系统自动分配 但是可以malloc出来一个区域然后指定//TODO 实验
- length 共享内存映射区大小
- prot protection 表示映射内存的保护属性 属性位|组合.告诉内核内存的访问级别
> - PROT_EXEC 页可能执行
> - PROT_READ 页可能读
> - PROT_WRITE 页可能写
> - PROT_NONE 页不能访问
- flags 标注共享内存的共享属性
> - MAP_SHARED 对内存修改反映到磁盘上
> - MAP_PRIVATE **对内存的修改不会反映到磁盘上**
- fd 共享内存打开的文件fd
- offset 偏移位置,需要是4k的整数倍 默认0 全部映射

返回值
- 成功: 映射区的首地址
- 失败: MAP_FAILED (void *) -1. errno

释放内存映射
int munmap(void *addr, size_t length);
- addr map返回值
- length 映射内存长度

返回
- 成功 0
- 失败  -1 errno

```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_RDWR|O_CREAT|O_TRUNC, 0644);
    if(fd == -1){
        sys_err("open err");
    }
    ftruncate(fd, 20);
    int len = lseek(fd, 0, SEEK_END);
    p = mmap(NULL, len, PROT_READ| PROT_WRITE, MAP_SHARED, fd, 0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }

    strcpy(p, "hello map");
    //strcpy(p, "hello map how is it of bigger than 20 , try it");


    int ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}
```
打开写入文件
```
hello map^@^@^@^@^@^@^@^@^@^@^@
```
后面写入文件空洞

如果写入长度超过20(指定的长度)
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_RDWR|O_CREAT|O_TRUNC, 0644);
    if(fd == -1){
        sys_err("open err");
    }
    ftruncate(fd, 20);
    int len = lseek(fd, 0, SEEK_END);
    p = mmap(NULL, 30, PROT_READ| PROT_WRITE, MAP_SHARED, fd, 0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }


    strcpy(p, "test how is it if longer than 20 what the fxxxxxxxxxxk");

    int ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}
不管内存长度比文件大还是一样,后续都是被截断
```
test how is it if lo
```

文件能写入但是截断.
```ditaa
     ┌──────────────────────────────────────────────────┐
     │                      memory                      │
     ├────────────────────────────┬──can write,but──────┘
   map                          map  ─not map in ────▶   
     ▼────────────────────────────▼      disk            
     │            disk            │                      
     └────────────────────────────┘                      
```

如果超过页长度 应该触发SIGSEV //TODO test 

问题:
####  open的时候直接O_CREAT而不ftruncate一个新文件做创建映射?
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_RDWR|O_CREAT|O_TRUNC, 0644);

    if(fd == -1){
        sys_err("open err");
    }
    int len = 20;
    /* ftruncate(fd, 20); */
    /* int len = lseek(fd, 0, SEEK_END); */
    p = mmap(NULL, 30, PROT_READ| PROT_WRITE, MAP_SHARED, fd, 0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }


    strcpy(p, "test how is it if longer than 20 what the fxxxxxxxxxxk");

    int ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}
```
不使用truncate,文件大小是0,默认新建.
指定新文件的时候:
```
➜  mmap ./mmap tt
[1]    22708 bus error (core dumped)  ./mmap tt
```
core了.
bus error,总线错误.
gdb看下core在哪里
```

Program received signal SIGSEGV, Segmentation fault.
0x00000000004006fe in main (argc=2, argv=0x7fffffffe1e8) at mmap.c:30
30          strcpy(p, "test how is it if longer than 20 what the fxxxxxxxxxxk");
Missing separate debuginfos, use: debuginfo-install glibc-2.17-260.el7_6.3.x86_64
(gdb)
```
在写入内存的时候core了//TODO 为什么是总线错误

**注意**
创建**映射区域文件的大小为0,实际非0大小创建映射区域**,出现总线错误.**这里是在写入内存才出错,mmap没出错**.
但是创建映射区域文件的大小不为0,程序不会core.
如果创建映射区大小为0,返回mmap的入参不合法

#### open fd read only,实际mmap要写入


```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_RDONLY);

    if(fd == -1){
        sys_err("open err");
    }
    int len = 30;
    p = mmap(NULL, len, PROT_READ| PROT_WRITE, MAP_SHARED, fd, 0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }


    strcpy(p, "test how is it if longer than 20 what the fxxxxxxxxxxk");

    int ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}

```

```
mmap ./mmap ttt
map fail: Permission denied
```
结论:fd只写,但是mmap要写入的时候,权限出错.这里是**在mmap的时候就出错了**.

#### mmap只读,往内存中写.

```cpp

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_RDONLY);

    if(fd == -1){
        sys_err("open err");
    }
    int len = 30;
    p = mmap(NULL, len, PROT_READ, MAP_SHARED, fd, 0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }


    strcpy(p, "test how is it if longer than 20 what the fxxxxxxxxxxk");

    int ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}

```

```
./mmap ttt
[1]    28862 segmentation fault (core dumped)  ./mmap ttt
```
gdb看下core的地方
```(gdb) r ttt
Starting program: /media/psf/centos/src/linux/mmap/mmap ttt

Program received signal SIGSEGV, Segmentation fault.
0x00000000004006f9 in main (argc=2, argv=0x7fffffffe1e8) at mmap.c:30
30          strcpy(p, "test how is it if longer than 20 what the fxxxxxxxxxxk");
(gdb)
```
看到是写入的时候core,就是写入保护的内存core


注意:这个时候是可以创建mmap的,只是到了写入的时候才发生错误.也就是内核不会为fd属性做检查.

#### open只写,mmap只读

```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_WRONLY| O_CREAT | O_TRUNC, 0664);

    if(fd == -1){
        sys_err("open err");
    }
    int len = 30;
    p = mmap(NULL, len, PROT_WRITE, MAP_SHARED, fd, 0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }


    strcpy(p, "test how is it if longer than 20 what the fxxxxxxxxxxk");

    int ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}

```
结果
```
➜  mmap ./mmap tt
map fail: Permission denied
```
没有权限访问
因为文件fd是按照只写的方式打开,但是内存映射只读.

**结论**类似文件权限和open权限用于,mmap的时候对fd的权限也有限制

#### fd只写,mmap只写
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_WRONLY| O_CREAT | O_TRUNC, 0664);

    if(fd == -1){
        sys_err("open err");
    }
    int len = 30;
    p = mmap(NULL, len, PROT_WRITE , MAP_SHARED, fd, 0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }


    strcpy(p, "test how is it if longer than 20 what the fxxxxxxxxxxk");

    int ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}
```

```
➜  mmap ./mmap t2
map fail: Permission denied
```
没有权限.
因此mmap必须要有文件的读权限才可以操作

**结论** mmap需要文件的读权限


总结:mmap权限要有文件fd的读权限,且mmap权限<=文件权限

#### fd先关闭对mmap是否影响
不影响
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_RDWR| O_CREAT | O_TRUNC, 0664);

    if(fd == -1){
        sys_err("open err");
    }
    int ret = 0;
    ret = ftruncate(fd, 20);
    if(ret == -1){
        printf("truncate err");
    }
    int len = 30;
    p = mmap(NULL, len, PROT_WRITE , MAP_SHARED, fd, 0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }
    close(fd);


    strcpy(p, "test how is it if");

    ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}
```
文件还能写入
```
test how is it if^@^@^@
```

**结论** fd关闭后还能让mmap操作

#### mmap最后参数是1000会怎样
返回
```
➜  mmap ./mmap t
map fail: Invalid argument
```
必须是4096的整数倍才行 -> 是**MMU***决定的

#### mmap最后参数diff如果超过文件大小会怎样
ex
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_RDWR| O_CREAT | O_TRUNC, 0664);

    if(fd == -1){
        sys_err("open err");
    }
    int ret = 0;
    ret = ftruncate(fd,4095);
    if(ret == -1){
        printf("truncate err");
    }
    int len = 30;
    p = mmap(NULL, len, PROT_WRITE , MAP_SHARED, fd, 4096);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }
    close(fd);


    strcpy(p, "test how is it if");

    ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}
```

```
➜  mmap ./mmap tt
[1]    29909 bus error (core dumped)  ./mmap tt
```
看下core的位置
```
Reading symbols from /media/psf/centos/src/linux/mmap/mmap...done.
(gdb) r t2
Starting program: /media/psf/centos/src/linux/mmap/mmap t2

Program received signal SIGBUS, Bus error.
0x0000000000400816 in main (argc=2, argv=0x7fffffffe258) at mmap.c:36
36	    strcpy(p, "test how is it if");
Missing separate debuginfos, use: debuginfo-install glibc-2.17-260.el7_6.3.x86_64
(gdb)
```
可以看到是在写入内存的时候core的.

如果超过了内存映射也最后一页写,会SIGSEV
```ditaa
     ┌──────────────────────────────────────────────────┬───────────────────┐
     │                 memory end page                  │ memory next page  │
     ├────────────────────────────┬─────────────────────┴───────────────────┘
   map                            │  can write,but      │   cant write from here       
     ▼────────────────────────────▼  ─not map in ────▶  │  ─get SIGSEV─────▶ 
     │            disk            │      disk           │      core          
     └────────────────────────────┘                                          
```

引发问题:**如果内存偏移在文件末端,但是写的长度超过了页?**
要写满一页才能测试.没写满的前提下超过文件末端无效

```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_RDWR| O_CREAT | O_TRUNC, 0664);

    if(fd == -1){
        sys_err("open err");
    }
    int ret = 0;
    ret = ftruncate(fd,5000);
    if(ret == -1){
        printf("truncate err");
    }
    int len = 30;
    p = mmap(NULL, len, PROT_WRITE , MAP_SHARED, fd,4096);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }
    close(fd);

    char ptest[6000]={0};
    int i = 0;
    for(i = 0; i < 6000;i++){
        ptest[i] = '1';
    }
    sprintf(p,ptest,6000);
    /* strcpy(p, "test how is it if"); */

    ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}
```
执行:
```
➜  mmap ./mmap we
[1]    3949 segmentation fault (core dumped)  ./mmap we
```

**结论**:会core.和上面结论一页,超过了文件长度roundup之后的也,写的时候回core SIGSEV


#### mmap的地址++之后能不能被munmap?
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_RDWR| O_CREAT | O_TRUNC, 0664);

    if(fd == -1){
        sys_err("open err");
    }
    int ret = 0;
    ret = ftruncate(fd,80);
    if(ret == -1){
        printf("truncate err");
    }
    int len = 30;
    p = mmap(NULL, len, PROT_WRITE , MAP_SHARED, fd,0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }
    close(fd);

    strcpy(p++, "test how is it if");

    ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}
```

返回非法
```
➜  mmap ./mmap t3
munmap err: Invalid argument
```
munmap申请的地址必须是mmap申请到的地址,否则返回入参非法

#### MAP_PRIVATE
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    void *p = NULL;
    int fd = open(argv[1],O_RDWR| O_CREAT | O_TRUNC, 0664);

    if(fd == -1){
        sys_err("open err");
    }
    int ret = 0;
    ret = ftruncate(fd,80);
    if(ret == -1){
        printf("truncate err");
    }
    int len = 30;
    p = mmap(NULL, len, PROT_WRITE ,MAP_PRIVATE, fd,0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }
    close(fd);

    strcpy(p, "test how is it if");

    ret = munmap(p, len);
    if(ret == -1){
        sys_err("munmap err");
    }

    return 0;
}
```
结果:文件没有写入

#### 总结
- mmap隐含文件
- map_shared要求mmap权限<=文件权限
- mmap释放与fd关闭无关,只要映射建立,fd可以关闭
- fd的文件大小为0,不能mmap,会core.如果mmap出现总线错误一般是fd的文件大小.ex:文件30,mmap偏移4096
- munmap传入mmap的地址,**不能对mmap地址++**
- offset偏移必须4K整数倍
- mmap创建很可能出错,必须检查返回

保险用法
fd = open("filename",O_RDWR);
mmap(NULL,<文件大小>,PROT_READ|PROT_WRITE, MAP_SHARED,fd,0);

### 父子进程间通信
需要建立通信,要用MAP_SHARED这个flag
- MAP_PRIVATE 父子进程各自独占映射区
- MAP_SHARED 共享
 
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int var = 100;
int main(int argc, char* argv[])
{
    int *p = NULL;
    int fd = open(argv[1],O_RDWR| O_CREAT | O_TRUNC, 0664);

    if(fd == -1){
        sys_err("open err");
    }

    int ret = 0;
    ret = ftruncate(fd,80);
    if(ret == -1){
        printf("truncate err");
    }
    int len = 30;
    //p = (int *) mmap(NULL, len, PROT_WRITE ,MAP_PRIVATE, fd,0);//读取的时候父进程读到0 因为各自一份内存
    p = (int *) mmap(NULL, len, PROT_WRITE ,MAP_SHARED, fd,0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }
    close(fd);

    pid_t pid = fork();
    if(pid == 0){
        *p = 2000;
        var = 1000;
        printf("child : *p=%d var=%d\n",*p, var);
        ret = munmap(p, len); if(ret == -1){
            sys_err("munmap err");
        }
    }
    else{
        sleep(1);
        printf("father: *p=%d var=%d\n",*p, var);
        ret = munmap(p, len); if(ret == -1){
            sys_err("munmap err");
        }
    }



    return 0;
}
```

#### 非血缘进程间通信
```cpp
//读
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <fcntl.h>
#include <sys/mman.h>

struct student{
    int id;
    char name[256];
    int age;
};

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    struct student stu = {1, "heiheihei", 18};
    struct student *p;
    int fd = open(argv[1],O_RDONLY);
    if(fd == -1){
        sys_err("open err");
    }
    ftruncate(fd, sizeof(stu));
    p = (struct student *)mmap(NULL, sizeof(stu), PROT_READ, MAP_SHARED, fd,0);
    close(fd);
    if(p == MAP_FAILED)
    {
        sys_err("mmap err");
    }

    while(1){

        printf("id=%d name=%s age=%d\n", p->id, p->name,p->age);
        sleep(1);
    }

    int ret = munmap(p, sizeof(stu));
    if(ret == -1)
    {
        perror("unmap fail");
    }

    return 0;
}

//写
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <fcntl.h>
#include <sys/mman.h>

struct student{
    int id;
    char name[256];
    int age;
};

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    struct student stu = {1, "heiheihei", 18};
    struct student *p;
    int fd = open(argv[1],O_RDWR|O_CREAT|O_TRUNC,0664);
    if(fd == -1){
        sys_err("open err");
    }
    ftruncate(fd, sizeof(stu));
    p = (struct student *)mmap(NULL, sizeof(stu), PROT_WRITE, MAP_SHARED, fd,0);
    close(fd);
    if(p == MAP_FAILED)
    {
        sys_err("mmap err");
    }

    while(1){
        memcpy(p, &stu, sizeof(stu));
        stu.id +=1;
        sleep(1);
    }

    int ret = munmap(p, sizeof(stu));
    if(ret == -1)
    {
        perror("unmap fail");
    }

    return 0;
}
```
可以多个写多个读同时进行,本质就是直接在一个内存空间操作.

**总结**
两个进程,打开同一个文件创建映射区
flags是MAP_SHARED
一个写入一个写出

### 匿名映射
不用每次都新建或者打开文件,直接拿到共享的内存空间 
flags |= MAP_ANON 不需要产生文件的前提下建立共享内存,没有名字.

小测试:如果文件创建后,建立mmap之后unlink了,文件还会不会存在?
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int var = 100;
int main(int argc, char* argv[])
{
    int *p = NULL;
    int fd = open(argv[1],O_RDWR| O_CREAT | O_TRUNC, 0664);

    if(fd == -1){
        sys_err("open err");
    }

    int ret = 0;
    ret = ftruncate(fd,80);
    if(ret == -1){
        printf("truncate err");
    }
    int len = 30;
    p = (int *) mmap(NULL, len, PROT_WRITE ,MAP_SHARED, fd,0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }
    close(fd);
    ret = unlink(argv[1]);
    if(ret == -1){
        printf("unlink err");
    }

    pid_t pid = fork();
    if(pid == 0){
        *p = 2000;
        var = 1000;
        printf("child : *p=%d var=%d\n",*p, var);
        ret = munmap(p, len); if(ret == -1){
            sys_err("munmap err");
        }
    }
    else{
        sleep(10);
        printf("father: *p=%d var=%d\n",*p, var);
        ret = munmap(p, len); if(ret == -1){
            sys_err("munmap err");
        }
    }



    return 0;
}
```
答案:不会


使用MAP_ANON,flags中|=MAP_ANON,并且fd设置为-1. 需要新一点的linux版本才支持.老的unix不支持.

```cpp

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/mman.h>
#include <fcntl.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int var = 100;
int main(int argc, char* argv[])
{
    int *p = NULL;
    int len = 80;
    p = (int *) mmap(NULL, len, PROT_WRITE ,MAP_SHARED | MAP_ANON, -1,0);
    if(p == MAP_FAILED){
        sys_err("map fail");
    }
    int ret = 0;

    pid_t pid = fork();
    if(pid == 0){
        *p = 2000;
        var = 1000;
        printf("child : *p=%d var=%d\n",*p, var);
        ret = munmap(p, len); if(ret == -1){
            sys_err("munmap err");
        }
    }
    else{
        sleep(10);
        printf("father: *p=%d var=%d\n",*p, var);
        ret = munmap(p, len); if(ret == -1){
            sys_err("munmap err");
        }
    }



    return 0;
}
```
返回
```
➜  mmap ./map_anon
child : *p=2000 var=1000
father: *p=2000 var=100
```


不支持匿名映射的机器,可以使用文件
`/dev/zero`,从这个文件中拿数据可以随便拿,但是都是文件空洞.
`dev/null`是文件黑洞,写什么这个文件都是null

如果机器不支持匿名映射,可以
int fd = open("/dev/zero",O_RDWR) 就不需要删除文件等操作
因为fork之后共享了mmap映射区,所以**只有有血缘关系的才能使用匿名映射

## 信号
#### 信号共性
- 简单
- 不能携带大量信息
- 满足条件才发送

#### 信号机制
通过软件方法实现,是软件层面的中断.一旦信号产生,无论程序执行到什么位置,必须立即停止运行,处理信号,处理结束才能继续执行后续指令.
每个进程收到的信号全部由内核负责发送,内核处理.
是驱使内核产生信号,不是自己产生信号

#### 产生信号
- 按键产生: ctrl-c ctrl-z ctrl-\
> - ctrl-z是把命令挂起,使用`bg`可以看到哪些进程被挂起,使用fd可以唤醒
- 系统调用 kill raise abort
- 软件条件产生 如:定时器alarm
- 硬件异常产生 如:非法访问内存(段错误 **SIGSEGV**),除0(浮点数例外 **SIGFPE**),内存对齐错误(总线错误 **SIGBUS**)
- 命令产生 如:kill命令

#### 递达
递送并到达进程,需要是cpu产生了信号而且到达了进程才算

#### 未决
内核产生信号但是还没送到进程.主要是**阻塞**导致的状态.

#### 处理方式
- 执行默认动作
- 忽略 **这里是执行的动作,不是阻塞信号**
- 捕捉(信号处理器)

#### 阻塞信号集
对某些信号加入集合设置屏蔽,当信号屏蔽后再收到信号,会对信号的处理推后(阻塞到信号接触屏蔽)
#### 未决信号集
- 信号产生,信号还没处理的时候. 针对信号产生到进程收到的时间:未决信号集在信号产生的时候进程对应该信号设置为1,表示`未决`,当信号处理之后转为0,表示`已处理`.这个时刻很短暂.
- 信号产生,因为进程`阻塞信号`没到达信号的时候.

未决信号集和阻塞信号集都在pcb中.都是bitmap.描述当前进程的所有信号.
也就是未决信号集和信号屏蔽字是两组bitmap.
进程拿到信号的时候,对应信号的位会置成1,其他置成0.

信号的处理
```ditaa
                                         未决信号集
                                            ┌─────┐               ┌─────┐            ┌─────┐
                                            │  0  │               │  0  │            │  0  │
                                            ├─────┤               ├─────┤            ├─────┤
                             ┌─────────────▶│  0  │               │  0  │            │  0  │
                             │              ├─────┤               ├─────┤            ├─────┤
                             │              │  0  │               │  0  │            │  0  │
                             │              ├─────┤    proc not   ├─────┤ after      ├─────┤
                             │              │  0  │─────dealed───▶│  1  │──done─────▶│  0  │
                             │              ├─────┤               ├─────┤            ├─────┤
                             │              │  0  │               │  0  │            │  0  │
                             │              ├─────┤               ├─────┤            ├─────┤
                             │              │  0  │               │  0  │            │  0  │
                             │              ├─────┤               ├─────┤            ├─────┤
                             │              │  0  │               │  0  │            │  0  │
                             │              ├─────┤               ├─────┤            ├─────┤
┌───────────────────────┐    │              │  0  │               │  0  │            │  0  │
│          pcb          │    │              ├─────┤               ├─────┤            ├─────┤
│        ┌────┐         │    │              │  0  │               │  0  │            │  0  │
│        │    │         │    │              ├─────┤               ├─────┤            ├─────┤
│        ├────┤         │    │              │ ... │               │ ... │            │ ... │
│        ├────┤─────────┼────┘              ├─────┤               ├─────┤            ├─────┤
│        ├────┤         │                   │  0  │               │  0  │            │  0  │
│        ├────┤─────────┼────┐              ├─────┤               ├─────┤            ├─────┤
│        │    │         │    │              │  0  │               │  0  │            │  0  │
│        └────┘         │    │              └─────┘               └─────┘            └─────┘
├───────────────────────┤    │                                                              
│                       │    │              信号屏蔽字                                          
│                       │    │              ┌─────┐                                         
│                       │    │              │  0  │                                         
│                       │    │              ├─────┤                                         
│                       │    └─────────────▶│  0  │                                         
│                       │                   ├─────┤                                         
│                       │                   │  0  │                                         
│                       │                   ├─────┤                                         
│                       │                   │  0  │                                         
│                       │                   ├─────┤                                         
│                       │                   │  0  │                                         
│                       │                   ├─────┤                                         
│                       │                   │  0  │                                         
│                       │                   ├─────┤                                         
│                       │                   │  0  │                                         
│                       │                   ├─────┤                                         
│                       │                   │  0  │                                         
│                       │                   ├─────┤                                         
└───────────────────────┘                   │  0  │                                         
                                            ├─────┤                                         
                                            │ ... │                                         
                                            ├─────┤                                         
                                            │  0  │                                         
                                            ├─────┤                                         
                                            │  0  │                                         
                                            └─────┘                                         
```
信号屏蔽字
```ditaa
                                         未决信号集
                                            ┌─────┐                ┌─────┐            ┌─────┐ 
                                            │  0  │                │  0  │            │  0  │ 
                                            ├─────┤                ├─────┤            ├─────┤ 
                             ┌─────────────▶│  0  │                │  0  │            │  0  │ 
                             │              ├─────┤                ├─────┤            ├─────┤ 
                             │              │  0  │                │  0  │            │  0  │ 
                             │              ├─────┤      2.proc    ├─────┤4.after     ├─────┤ 
                             │              │  0  │────────not ───▶│  1  │──done─────▶│  0  │ 
                             │              ├─────┤      dealed    ├─────┤            ├─────┤ 
                             │              │  0  │                │  0  │            │  0  │ 
                             │              ├─────┤                ├─────┤            ├─────┤ 
                             │              │  0  │                │  0  │            │  0  │ 
                             │              ├─────┤                ├─────┤            ├─────┤ 
                             │              │  0  │                │  0  │            │  0  │ 
                             │              ├─────┤                ├─────┤            ├─────┤ 
┌───────────────────────┐    │              │  0  │                │  0  │            │  0  │ 
│          pcb          │    │              ├─────┤                ├─────┤            ├─────┤ 
│        ┌────┐         │    │              │  0  │                │  0  │            │  0  │ 
│        │    │         │    │              ├─────┤                ├─────┤            ├─────┤ 
│        ├────┤         │    │              │ ... │                │ ... │            │ ... │ 
│        ├────┤─────────┼────┘              ├─────┤                ├─────┤            ├─────┤ 
│        ├────┤         │                   │  0  │                │  0  │            │  0  │ 
│        ├────┤─────────┼────┐              ├─────┤                ├─────┤            ├─────┤ 
│        │    │         │    │              │  0  │                │  0  │            │  0  │ 
│        └────┘         │    │              └─────┘                └─────┘            └─────┘ 
├───────────────────────┤    │                                                                
│                       │    │                                                                
│                       │    │              ┌─────┐                 ┌─────┐            ┌─────┐
│                       │    │              │  0  │                 │  0  │            │  0  │
│                       │    │              ├─────┤                 ├─────┤            ├─────┤
│                       │    └─────────────▶│  0  │                 │  0  │            │  0  │
│                       │                   ├─────┤                 ├─────┤            ├─────┤
│                       │                   │  0  │                 │  0  │            │  0  │
│                       │                   ├─────┤       1.proc    ├─────┤ 3.proc     ├─────┤
│                       │                   │  0  │────────block───▶│  1  │unblock────▶│  0  │
│                       │                   ├─────┤                 ├─────┤            ├─────┤
│                       │                   │  0  │                 │  0  │            │  0  │
│                       │                   ├─────┤                 ├─────┤            ├─────┤
│                       │                   │  0  │                 │  0  │            │  0  │
│                       │                   ├─────┤                 ├─────┤            ├─────┤
│                       │                   │  0  │                 │  0  │            │  0  │
│                       │                   ├─────┤                 ├─────┤            ├─────┤
│                       │                   │  0  │                 │  0  │            │  0  │
│                       │                   ├─────┤                 ├─────┤            ├─────┤
└───────────────────────┘                   │  0  │                 │  0  │            │  0  │
                                            ├─────┤                 ├─────┤            ├─────┤
                                            │ ... │                 │ ... │            │ ... │
                                            ├─────┤                 ├─────┤            ├─────┤
                                            │  0  │                 │  0  │            │  0  │
                                            ├─────┤                 ├─────┤            ├─────┤
                                            │  0  │                 │  0  │            │  0  │
                                            └─────┘                 └─────┘            └─────┘
```

kill -l看到所有信号.
- 1到31:常规信号/普通信号.**有默认处理动作,系统编程中用到**.
- 34到64:实时信号,没有默认处理.硬件驱动之类会用到,系统编程用不到.

#### 信号四要素
- 编号
- 名称
- 事件(什么情况应该产生信号,当前情况是否应该产生该信号)
- 默认处理动作(大部分内核会处理,大部分内核使用默认处理动作)

man 7 signal看到手册解释
不同操作系统的信号对应的值是不同的,arm和x86基本一样.但是名字是一样的.**所以使用宏不会出错.其他地方一样,例如STDIN_FILENO这些**

常规信号
|值|名称|事件|默认处理|
|----|----|----|----|
|1|**SIGHUP** |  shell直接关闭的时候,shell的子进程收到.默认终止进程.|关闭|
| 2|**SIGINT** | 中断 ctrl-c 终端给子程序发出.|默认终止.|
| 3|**SIGQUIT**| 退出 ctrl-\ 终端向子程序发出.|默认终止.|
| 4|SIGILL |非法指令  少用到.| core|
| 5|SIGTRAP| 断点指令,一般gdb调试产生.core.gcc加上-g就是为了产生core文件,在调试中用到.  TODO 了解|core|
| 6|SIGABRT |调用abort函数.|core|
|7|SIGBUS|非法访问内存,包括内存对齐|core|
|8|**SIGFPE**|浮点错,移除或者除数为0|core|
|9|**SIGKILL**|无条件终止进程,**不能被忽略,处理,阻塞**,给系统管理员提供**唯一有效杀死进程方法**|终止|
|10|**SIGUSR1**|用户自定义1|终止|
|11|**SIGSEGV**|段错误,访问无效内存|core|
|12|**SIGUSR2**|用户自定义|终止|
|13|**SIGPIPE**|broken pipe,向一个没有w end的pipe写|终止|
|14|**SIGALRM**|定时器超时,alarm函数|终止|
|15|**SIGTERM**|程序结束信号,**可以被阻塞和终止**,执行shell系统`kill时候默认产生`这个信号|终止|
|16|SIGSTKFLT|早起linux版本,未兼容|终止|
|17|**SIGCHLD**|子进程停止或者终端|**忽略**|
|18|SIGCONT|停止进程继续|继续|
|19|**SIGSTOP**|暂停,**不能被忽略,处理,阻塞**,给系统管理员提供**唯一有效暂停进程方法**|暂停|
|20...34|不太重要|  TODO补充|待续|

**不应乱发信号**


### kill

int kill(pid_t pid, int sig)
sig:发送的信号.
pid:(和waitpid类似)
- >0 指定pid
- 0 同gid所有进程
- <0 给gid是|pid|的进程发送信号
- -1 给能发送的所有进程都发 进程只能向自己创建的进程发信号.
返回
- -1 失败 errno
- 0 成功

测试:让父进程kill一个信号过去子进程
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>
#include <sys/signal.h>
#include <sys/wait.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    pid_t pid = fork();
    int status = 0;
    if(pid < 0){
        sys_err("fork err");
    }
    if(pid > 0){
        sleep(2);
        if(argc == 3)
        {

            kill(atoi(argv[2]),atoi(argv[1]));

        }
        else{

            kill(pid,atoi(argv[1]));

        }
        wait(&status);
        if(WIFSIGNALED(status)){
            printf("child killed by signal %d\n",WTERMSIG(status));
        }
        if(WCOREDUMP(status)){
            printf("child core\n");
        }

    }
    else {
        sleep(3);
    }
    return 0;
}
```
可以看到:
子进程过了3s之后才会被kill.可以看到:进程在挂起过程不会受到信号.**在进程拿到下一个时间片的时候,信号才会带给进程**.
信号发送机制:
```ditaa
   ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
   │time1│time2│time3│time4│time5│time6│time7│ ... │
   └──▲──┴──▲──┴──▲──┴─────┴─────┴─────┴─────┴─────┘
      │     │     │                                 
      │     │     │                                 
      │     └────┐└───────────┐                     
     ┌┘     send sig      get sig                   
     │     to proc 1     form proc                  
     │           │           2│                     
     │           │            │                     
┌────┴───┬──────────────┬───────────┐               
│process1│   process2   │ process1  │               
└────────┴──────────────┴───────────┘               
```
**注意**如果传入的pid是-1,体验到的效果是直接退出登录....

**普通用户消息发送规则:发送者实际或者有效用户ID == 接收者实际或有效ID**
操作不了的(比如使用内核的),使用sudo

### alarm (软件条件产生信号)
pcb中父子进程不同的:pid,创建时间,定时器.
定时发送SIGALRM给调用进程.
**每个进程有且只有一个定时器**

unsigned int alarm(unsigned int seconds);
返回:上次定时器设置过的剩余时间.
反复调用定时器:定时器会重置(会覆盖) 因为定时器只有一个.**没有失败情况**.
0:表示之前没有设置 alarm(0)取消定时器

测试1s能算多少个数(不准确,因为printf有写io的延时.应该用信号处理器)
```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <pthread.h>

void sys_err(const char* str){
    perror(str);
    exit(1);
}

int main(int argc, char* argv[])
{
    int i = 0;
    alarm(1);
    while(1){
        printf("%d\n",i++);
    }
    return 0;
}
```
time <二进制>能看到二进制执行过程的时间占用

如果不直接执行,而是 ./二进制 > a 能看到a里的数字比输出的多,因为显示在屏幕的时候需要占用更多系统资源
实际执行时间=系统时间+用户时间+等待时间(更多是等待设备.会等待内存,cpu等)
结论:程序运行瓶颈在IO.优化程序**首选优化IO**







### settimer (软件条件产生信号)

### 其他信号函数
abort
raise