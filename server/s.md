
# s1

```ditaa
          ┌──────────────────────────────────────────────────────────────────────────────────────────────┐                                                  
          │                                          rpc frame                                           │                                                  
          │                                                                                              │                                                  
          │      ┌────────────────────┐     ┌────────────────────────┐      ┌────────────────────────┐   │                                                  
          │      │    epoll layer     │     │   data communication   │      │   data communication   │   │                                                  
          │      │                    │     │                        │      │                        │   │                                                  
          │      │                    │     │  ┌────────────────┐    │      │                        │   │                                                  
          │      │                    │     │  │   semaphore    │    │      │                        │   │                                                  
┌────┐    │      │ ┌────────────────┐ │     │  └────────────────┘    │      │                        │   │                                                  
│cli │────┼──────┼▶│ accept thread  │ │     │                        │      │   ┌────────────────┐   │   │                                                  
└────┘    │      │ └────────────────┘ │     │  ┌────────────────┐    │      │   │  Master proc   │   │   │                                         ┌───────┐
   │      │      │          │         │  ┌──┼─▶│in q(shm array) │────┼┐     │   ├────────────────┤   │   │  domain         ┌────────────────┐      │  svr  │
   │      │      │          │         │  │  │  └────────────────┘    │├────▶│   │  worker proc   │   │───┼──socket────────▶│   conn agent   │─────▶│callee │
   │      │      │          ▼         │  │  │                        ││     │   ├────────────────┤   │   │                 └────────────────┘      └───────┘
   │      │      │ ┌────────────────┐ │  │  │  ┌────────────────┐    ││     │   │  worker proc   │   │   │                                                  
   └──────┼──────┼▶│  epoll thread  │◀┼──┴──┼──│out q(shm array)│◀───┼┘     │   ├────────────────┤   │   │                                                  
          │      │ └────────────────┘ │     │  └────────────────┘    │      │   │  worker proc   │   │   │                                                  
          │      │                    │     │                        │      │   └────────────────┘   │   │                                                  
          │      │                    │     │                        │      │                        │   │                                                  
          │      │                    │     │                        │      │                        │   │                                                  
          │      └────────────────────┘     └────────────────────────┘      └────────────────────────┘   │                                                  
          │                                                                              │               │                                                  
          └──────────────────────────────────────────────────────────────────────────────┼───────────────┘                                                  
                                                                                         │                                                                  
                                                                                         │                                                                  
                                                                                         │                                                                  
                                                                                         ▼                                                                  
                                                                                ┌────────────────┐                                                          
                                                                                │   log report   │                                                          
                                                                                └────────────────┘                                                                                                 
```

问题所在:
1.使用信号量做做共享内存队列的锁机制,而且队列是类似数组的形式管理,入队和出队都会有锁产生
2.使用domain socket做连接agent调用下游服务,事实上调用到下游再回包,domain socket两次读写,socket两次读写,调用下游有4次socket读写.



## s2
```ditaa
          ┌──────────────────────────────────────────────────────────────────────────────────────────────┐
          │                                                                                              │
          │                                                                                              │
          │      ┌────────────────────┐ ┌───────────────────────────────┐   ┌────────────────────────┐   │
          │      │                    │ │                               │   │                        │   │
          │      │                    │ │                               │   │                        │   │
          │      │    epoll layer     │ │                               │   │   data communication   │   │
          │      │                    │ │      data communication       │   │                        │   │
┌────┐    │      │ ┌────────────────┐ │ │                               │   │                        │   │
│cli │────┼──────┼▶│ accept thread  │ │ │                               │   │   ┌────────────────┐   │   │
└────┘    │      │ └────────────────┘ │ │        ┌────────────────┐     │   │   │  Master proc   │   │   │
   │      │      │          │         │ │ ┌─────▶│in q(shm llist) │CAS─┐│   │   ├────────────────┤   │   │
   │      │      │          │         │ │ │      └────────────────┘    ││   │   │  worker proc   │   │   │
   │      │      │          ▼         │ │ │                            ││   │   ├────────────────┤   │   │
   │      │      │ ┌────────────────┐ │ │ │      ┌────────────────┐    ├┼──▶│   │  worker proc   │   │   │
   └──────┼──────┼▶│  epoll thread  │◀┼─┼─┴CAS───│out q(shm llist)│CAS─┘│   │   ├────────────────┤   │   │
          │      │ └────────────────┘ │ │        └────────────────┘     │   │   │  worker proc   │   │   │
          │      │                    │ │                               │   │   └────────────────┘   │   │
          │      │ ┌────────────────┐ │ │        ┌────────────────┐     │   │                        │   │
          │      │ │   conn pool    │◀┼─┼────────│in q(shm llist) │◀────┼───┤                        │   │
          │      │ └────────────────┘─┼─┼─┐      └────────────────┘     │   │                        │   │
          │      │          │         │ │ │      ┌────────────────┐     │   │                        │   │
          │      │          │         │ │ └─────▶│      pipe      │─────┼───▶                        │   │
          │      │          │         │ │        └────────────────┘     │   │                        │   │
          │      └──────────┼─────────┘ │                               │   └────────────────────────┘   │
          │                 │           └───────────────────────────────┘                │               │
          └─────────────────┼────────────────────────────────────────────────────────────┼───────────────┘
                            │                                                            │                
                       long live                                                         │                
                          conn                                                           ▼                
                            │                                                   ┌────────────────┐        
                            │                                                   │  satic report  │        
                            │                                                   └────────────────┘        
                            │                                                            │                
                            │                                                            │                
                            ▼                                                            │                
                        ┌───────┐                                                        │                
                        │  svr  │                                                        ▼                
                        │callee │                                               ┌────────────────┐        
                        └───────┘                                               │   log report   │        
                                                                                └────────────────┘           
```

1.不使用系统锁进行队列控制
2.改用链表方式入/出队列
3.不使用连接代理.使用连接池管理下游服务长连接,直接使用出队.

### in q
单写多读.
使用数组+链表
头进尾出

```ditaa
freelist                         readidx             writeidx
┌─────┐                 ┌──────┬──────┬──────┬──────┬──────┐
│ 8k  │                 │ idx0 │ idx1 │ idx2 │ ...  │ idxN │
│     │────────┐        └──────┴──────┴──────┴──────┴──────┘
├─────┤        │            │      │      │            │    
│ 8k  │        │            │      │      │            │    
│     │        │            ▼      ▼      ▼            ▼    
├─────┤    require       ┌─────┐┌─────┐┌─────┐      ┌─────┐ 
│ ... │        │         │ 8k  ││ 8k  ││ 8k  │      │ 8k  │ 
│     │        └────────▶│     ││     ││     │      │     │ 
├─────┤                  └─────┘└─────┘└─────┘      └─────┘ 
│ 8k  │                     │                               
│     │                     ▼                               
└─────┘                  ┌─────┐                            
                         │ 8k  │                            
                         │     │                            
                         └─────┘                            
```
因为单写多读.写端(生产端)从epoll侧写入,读端(消费端)通过cas方式锁住readidx进行消费.
push:
1.定期从freelist(可理解内存池)申请多块内存
2.讲buff放入链表中
3.writeidx++
push完全无锁,因为writeidx是挂完链表再自增的.这里epoll只有一个线程.

pop:
1.**CAS**readidx++
2.拿buff

改进点:原来是整个内存加锁,现在只是对readidx加锁.这里粒度降低.

### out q
多写单读
使用链表
头进整出
```ditaa
freelist
┌─────┐                 ┌──────┐     ┌──────┐    ┌──────┐    ┌──────┐
│ 8k  │                 │ idxN │────▶│ ...  │───▶│ idx2 │───▶│ idx1 │
│     │────────┐        └──────┘     └──────┘    └──────┘    └──────┘
├─────┤        │            │            │           │           │   
│ 8k  │        │            │            │           │           │   
│     │        │            ▼            ▼           ▼           ▼   
├─────┤    require       ┌─────┐      ┌─────┐     ┌─────┐     ┌─────┐
│ ... │        │         │ 8k  │      │ 8k  │     │ 8k  │     │ 8k  │
│     │        └────────▶│     │      │     │     │     │     │     │
├─────┤                  └─────┘      └─────┘     └─────┘     └─────┘
│ 8k  │                     │                                        
│     │                     ▼                                        
└─────┘                  ┌─────┐                                     
                         │ 8k  │                                     
                         │     │                                     
                         └─────┘                                     
```
push:
1.申请内存
2.buff放入链表
3.加入到链表头
4.**CAS**修改头指针
通过cas,确保链表正确.和上述pop一样,减少锁粒度.

pop:
1.**CAS**head设置NULL
2.整个内存取出.

把所有的内容都取出来,除了head设置之外没有冲突.这里也没有竞争问题.


### 调用下游
```ditaa
                                                                                                           
                                                                                                            
                                 ┌────────────────┐                                                         
         ┌───────────────────────│out q(shm llist)│◀────────────┐                                           
         │                       └────────────────┘             │                                           
         │                                                      │                                           
         │                                                      │                                           
         ▼                                                      │                                           
┌────────────────┐                                              │                                           
│  worker proc   │───────┐                                      │                                           
├────────────────┤       │                                      │                                  ┌───────┐
│  worker proc   │───────┤       ┌────────────────┐       ┌───────────┐        ┌───────────┐       │  svr  │
├────────────────┤       ├──────▶│in q(shm llist) │──────▶│   epoll   │───────▶│ conn pool │──────▶│callee │
│  worker proc   │───────┤       └────────────────┘       └───────────┘        └───────────┘       └───────┘
├────────────────┤       │                                      │                                           
│  worker proc   │───────┘                                      │                                           
└────────────────┘                                              │                                           
         ▲                                                      │                                           
         │                                                      │                                           
         └───────────────────pipe───────────────────────────────┘                                           
                                                                                                                                                  
                                                                                                            

```

### 解决低tps
epoll和libco都是异步框架,当请求量低的时候,worker和epoll轮转可能4ms一次,一个请求如果要4次轮转,->约20ms耗时.

epoll入inq:向任意一个worker发送pipe
worker入队outq:向对应epoll发送pipe
但是pipe消耗系统资源
==>
epoll < 6000/s 每次入队发送pipe
epoll > 6000/s 不发送pipe,直接触发


### 故障屏蔽
进程token:进程级别token在异常处理会减去,减少到一定量 快速拒绝
服务token:类似上述,但是是服务的,进程共享.减少到一定量,gg

### 过载保护
inq或者outq耗时每500次或者1s计算平均耗时.大于:减少通过率.小于:增大通过率.

